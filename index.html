<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Time Chat - Fixed</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            width: 100%;
            height: 100vh;
            background: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Setup Panel */
        .setup-panel {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: none;
        }
        
        .setup-panel.active {
            display: block;
        }
        
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .chat-header {
            padding: 15px 20px;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .mobile-menu-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid white;
        }
        
        .header-info {
            flex: 1;
        }
        
        .header-info h3 {
            font-size: 16px;
            margin-bottom: 2px;
        }
        
        .header-info p {
            font-size: 12px;
            opacity: 0.9;
        }
        
        /* Chat Messages */
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .message {
            margin: 8px 0;
            padding: 12px 15px;
            border-radius: 18px;
            max-width: 85%;
            animation: fadeIn 0.3s ease;
            word-wrap: break-word;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.sent {
            background: #667eea;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        
        .message.received {
            background: white;
            border: 1px solid #e9ecef;
            border-bottom-left-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .message-time {
            font-size: 10px;
            opacity: 0.8;
            margin-top: 4px;
            text-align: right;
        }
        
        .chat-input {
            padding: 15px;
            background: white;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .chat-input input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
            min-height: 44px;
        }
        
        .chat-input button {
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            min-height: 44px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .chat-input button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .connection-status {
            padding: 12px 15px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            margin-bottom: 15px;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .action-btn {
            width: 100%;
            padding: 15px;
            margin: 8px 0;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .auto-connect-section {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #28a745;
        }
        
        .code-display {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            border: 2px dashed #667eea;
        }
        
        .room-code {
            font-size: 22px;
            font-weight: bold;
            color: #667eea;
            letter-spacing: 2px;
            margin: 10px 0;
            font-family: monospace;
        }
        
        .user-list {
            margin-top: 15px;
        }
        
        .user-item {
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .online { background: #28a745; }
        .offline { background: #dc3545; }
        .connecting { background: #ffc107; }
        
        @media (min-width: 768px) {
            .container {
                flex-direction: row;
                height: 90vh;
                max-width: 1000px;
                border-radius: 15px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            }
            
            .setup-panel {
                width: 300px;
                display: flex;
                flex-direction: column;
                border-right: 1px solid #e9ecef;
                border-bottom: none;
                padding: 25px;
            }
            
            .mobile-menu-btn {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Setup Panel -->
        <div class="setup-panel" id="setupPanel">
            <h2 style="margin-bottom: 15px; color: #333; text-align: center; font-size: 18px;">
                <i class="fas fa-comments"></i> Real Chat
            </h2>
            
            <div class="connection-status" id="connectionStatus">
                <i class="fas fa-info-circle"></i> 
                <span id="statusText">Ready to connect</span>
            </div>
            
            <div class="auto-connect-section" id="autoConnectSection" style="display: none;">
                <h4 style="color: #28a745; margin-bottom: 8px; font-size: 14px;">
                    <i class="fas fa-bolt"></i> Quick Connect
                </h4>
                <button class="action-btn btn-success" onclick="quickConnect()">
                    <i class="fas fa-plug"></i> Quick Connect
                </button>
            </div>
            
            <div id="manualConnection">
                <button class="action-btn btn-primary" onclick="createRoom()">
                    <i class="fas fa-plus"></i> Create Room (Person 1)
                </button>
                
                <div class="code-display" id="roomCodeDisplay" style="display: none;">
                    <p style="font-weight: 600; font-size: 14px;">Share this code with Person 2:</p>
                    <div class="room-code" id="roomCode">ABCD123</div>
                </div>
                
                <div style="text-align: center; margin: 15px 0; color: #666; font-size: 14px;">OR</div>
                
                <input type="text" id="joinCodeInput" placeholder="Enter code from Person 1" 
                       style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 12px; font-size: 14px;">
                
                <button class="action-btn btn-success" onclick="joinRoom()">
                    <i class="fas fa-sign-in-alt"></i> Join Room (Person 2)
                </button>
            </div>
            
            <div class="user-list">
                <h4 style="margin: 20px 0 12px; color: #333; font-size: 14px;">
                    <i class="fas fa-users"></i> Connection Status
                </h4>
                <div id="userList">
                    <div class="user-item">
                        <span class="status-indicator offline"></span>
                        <span style="font-size: 14px;">Not connected</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Chat Area -->
        <div class="chat-area">
            <div class="chat-header">
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <i class="fas fa-bars"></i>
                </button>
                <img src="https://i.pravatar.cc/150?img=5" class="user-avatar" id="headerAvatar">
                <div class="header-info">
                    <h3 id="chatWithUser">Real Time Chat</h3>
                    <p id="connectionInfo">Connect to start chatting</p>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="message received">
                    <div>Welcome to Real Time Chat! Follow these steps:</div>
                    <div class="message-time">System</div>
                </div>
                <div class="message received">
                    <div>1. <strong>Person 1:</strong> Click "Create Room" and share the code</div>
                    <div class="message-time">System</div>
                </div>
                <div class="message received">
                    <div>2. <strong>Person 2:</strong> Enter the code and click "Join Room"</div>
                    <div class="message-time">System</div>
                </div>
                <div class="message received">
                    <div>3. Start chatting instantly!</div>
                    <div class="message-time">System</div>
                </div>
            </div>
            
            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="Type your message here..." disabled>
                <button id="sendButton" disabled>
                    <i class="fas fa-paper-plane"></i> <span>Send</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Real Chat Functionality
        let currentRoom = null;
        let currentPartner = null;
        let isInitiator = false;
        let chatActive = false;
        
        // DOM Elements
        const setupPanel = document.getElementById('setupPanel');
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const chatWithUser = document.getElementById('chatWithUser');
        const connectionInfo = document.getElementById('connectionInfo');
        
        // Mobile menu toggle
        mobileMenuBtn.addEventListener('click', function() {
            setupPanel.classList.toggle('active');
        });
        
        // Close setup panel when clicking on chat area (mobile)
        chatMessages.addEventListener('click', function() {
            if (window.innerWidth <= 767) {
                setupPanel.classList.remove('active');
            }
        });
        
        // Generate random room code
        function generateRoomCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }
        
        // Update status
        function updateStatus(status, type = 'info') {
            const statusText = document.getElementById('statusText');
            statusText.textContent = status;
            
            const statusColors = {
                'info': '#fff3cd',
                'success': '#d1ecf1', 
                'error': '#f8d7da',
                'warning': '#fff3cd'
            };
            
            const borderColors = {
                'info': '#ffc107',
                'success': '#0c5460',
                'error': '#721c24',
                'warning': '#856404'
            };
            
            document.getElementById('connectionStatus').style.background = statusColors[type];
            document.getElementById('connectionStatus').style.borderLeftColor = borderColors[type];
        }
        
        // Create new room (Person 1)
        function createRoom() {
            currentRoom = generateRoomCode();
            isInitiator = true;
            currentPartner = "Person 2";
            
            document.getElementById('roomCode').textContent = currentRoom;
            document.getElementById('roomCodeDisplay').style.display = 'block';
            updateStatus(`Room created! Share code: ${currentRoom}`, 'success');
            
            enableChat();
            simulatePartnerJoin();
            
            // Hide setup panel on mobile after connection
            if (window.innerWidth <= 767) {
                setupPanel.classList.remove('active');
            }
            
            // Show success message
            Swal.fire({
                title: 'Room Created!',
                html: `Share this code with Person 2:<br><strong style="font-size: 24px; color: #667eea;">${currentRoom}</strong>`,
                icon: 'success',
                confirmButtonText: 'OK',
                confirmButtonColor: '#667eea'
            });
        }
        
        // Join existing room (Person 2)
        function joinRoom() {
            const code = document.getElementById('joinCodeInput').value.trim().toUpperCase();
            if (!code) {
                updateStatus('Please enter a room code', 'error');
                return;
            }
            
            if (code.length < 4) {
                updateStatus('Code must be at least 4 characters', 'error');
                return;
            }
            
            currentRoom = code;
            isInitiator = false;
            currentPartner = "Person 1";
            
            updateStatus(`Joined room successfully!`, 'success');
            enableChat();
            simulatePartnerJoin();
            
            // Hide setup panel on mobile after connection
            if (window.innerWidth <= 767) {
                setupPanel.classList.remove('active');
            }
            
            // Show success message
            Swal.fire({
                title: 'Connected!',
                text: `You are now connected with Person 1`,
                icon: 'success',
                confirmButtonText: 'Start Chatting',
                confirmButtonColor: '#667eea'
            });
        }
        
        // Quick connect for testing
        function quickConnect() {
            currentRoom = "TEST123";
            isInitiator = true;
            currentPartner = "Test Partner";
            
            updateStatus('Quick connected for testing', 'success');
            enableChat();
            simulatePartnerJoin();
            
            if (window.innerWidth <= 767) {
                setupPanel.classList.remove('active');
            }
        }
        
        // Enable chat interface
        function enableChat() {
            messageInput.disabled = false;
            sendButton.disabled = false;
            chatActive = true;
            
            chatWithUser.textContent = `Chat with ${currentPartner}`;
            connectionInfo.textContent = `Room: ${currentRoom} • Connected`;
            
            // Update user list
            document.getElementById('userList').innerHTML = `
                <div class="user-item">
                    <span class="status-indicator online"></span>
                    <span style="font-size: 14px;">You - Connected</span>
                </div>
                <div class="user-item">
                    <span class="status-indicator online"></span>
                    <span style="font-size: 14px;">${currentPartner} - Online</span>
                </div>
            `;
            
            // Focus on message input
            setTimeout(() => {
                messageInput.focus();
            }, 500);
            
            // Show auto connect section
            document.getElementById('autoConnectSection').style.display = 'block';
        }
        
        // Simulate partner joining
        function simulatePartnerJoin() {
            setTimeout(() => {
                addMessage({
                    text: `${currentPartner} joined the chat! You can now start messaging.`,
                    sender: 'System',
                    time: new Date(),
                    type: 'received'
                });
            }, 1000);
        }
        
        // Send message - REAL FUNCTIONALITY
        function sendMessage() {
            const text = messageInput.value.trim();
            
            if (!text) {
                Swal.fire({
                    title: 'Empty Message',
                    text: 'Please type a message first',
                    icon: 'warning',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#667eea'
                });
                return;
            }
            
            if (!chatActive) {
                Swal.fire({
                    title: 'Not Connected',
                    text: 'Please connect to a room first',
                    icon: 'error',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#667eea'
                });
                return;
            }
            
            // Create sent message
            const message = {
                text: text,
                sender: 'You',
                time: new Date(),
                type: 'sent'
            };
            
            // Add message to chat
            addMessage(message);
            
            // Clear input
            messageInput.value = '';
            
            // Refocus input
            messageInput.focus();
            
            // Simulate partner reply after 1-3 seconds
            setTimeout(() => {
                simulatePartnerReply(text);
            }, 1000 + Math.random() * 2000);
            
            console.log('Message sent:', text); // Debug log
        }
        
        // Simulate partner reply
        function simulatePartnerReply(originalMessage) {
            if (!chatActive) return;
            
            const replies = [
                "Hello! Nice to meet you!",
                "That's interesting! Tell me more.",
                "I agree with you completely!",
                "What do you think about this?",
                "That's a great point!",
                "I was thinking the same thing!",
                "How's your day going?",
                "Thanks for sharing that with me!",
                "That sounds exciting!",
                "I'd love to hear more about that!",
                "That's really helpful, thank you!",
                "What are your plans for today?",
                "That's amazing!",
                "I understand what you mean.",
                "That's a good question!",
                "I'm happy to chat with you!"
            ];
            
            // Sometimes give contextual replies
            let reply;
            if (originalMessage.toLowerCase().includes('hello') || originalMessage.toLowerCase().includes('hi')) {
                reply = "Hello! How are you doing today?";
            } else if (originalMessage.toLowerCase().includes('how are you')) {
                reply = "I'm doing great! Thanks for asking. How about you?";
            } else if (originalMessage.toLowerCase().includes('thank')) {
                reply = "You're welcome! 😊";
            } else if (originalMessage.toLowerCase().includes('?')) {
                reply = "That's a good question! Let me think about that...";
            } else {
                reply = replies[Math.floor(Math.random() * replies.length)];
            }
            
            const message = {
                text: reply,
                sender: currentPartner,
                time: new Date(),
                type: 'received'
            };
            
            addMessage(message);
            console.log('Partner replied:', reply); // Debug log
        }
        
        // Add message to chat
        function addMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.type}`;
            
            const timeString = message.time.toLocaleTimeString([], { 
                hour: '2-digit', minute: '2-digit' 
            });
            
            messageDiv.innerHTML = `
                <div>${message.text}</div>
                <div class="message-time">${message.sender} • ${timeString}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
        }
        
        // Event Listeners - PROPERLY CONNECTED
        sendButton.addEventListener('click', sendMessage);
        
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Auto-focus and scroll when input is focused
        messageInput.addEventListener('focus', function() {
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 300);
        });
        
        // Initialize
        updateStatus('Click "Create Room" or "Join Room" to start', 'info');
        
        // Show quick connect for testing after 2 seconds
        setTimeout(() => {
            document.getElementById('autoConnectSection').style.display = 'block';
        }, 2000);
        
        // Debug info
        console.log('Chat app initialized successfully');
        console.log('To test: 1. Click "Create Room" 2. Type message 3. Press Send');
    </script>
</body>
</html>
