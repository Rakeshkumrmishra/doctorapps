<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time WhatsApp Status</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            min-height: 100vh;
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        
        /* Fixed Navigation Bar */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 1000;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }
        
        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            color: #6e8efb;
            font-size: 20px;
        }
        
        .nav-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
            transition: all 0.3s ease;
        }
        
        .status-dot.active {
            background: #28a745;
            box-shadow: 0 0 10px #28a745;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .nav-time {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            margin-top: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 800px;
            height: 80vh;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            padding: 20px;
            background: #6e8efb;
            color: white;
            text-align: center;
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #f5f7fb;
            display: flex;
            flex-direction: column;
        }
        
        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-end;
            max-width: 80%;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateY(20px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        .message.received {
            align-self: flex-start;
        }
        
        .message.sent {
            align-self: flex-end;
            margin-left: auto;
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 8px;
        }
        
        .message-content {
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 100%;
            word-wrap: break-word;
            position: relative;
        }
        
        .received .message-content {
            background-color: white;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .sent .message-content {
            background: linear-gradient(135deg, #6e8efb, #5a7dfa);
            color: white;
            border-bottom-right-radius: 5px;
            box-shadow: 0 2px 8px rgba(106, 142, 251, 0.3);
        }
        
        .message-time {
            font-size: 11px;
            margin-top: 5px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 5px;
        }
        
        .received .message-time {
            color: #666;
        }
        
        .sent .message-time {
            color: rgba(255, 255, 255, 0.8);
        }
        
        /* WhatsApp Style Status */
        .message-status {
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 2px;
        }
        
        .status-single-tick {
            opacity: 0.7;
        }
        
        .status-double-tick {
            opacity: 0.7;
        }
        
        .status-double-tick-blue {
            color: #53bdeb !important;
            opacity: 1;
        }
        
        .chat-input-container {
            padding: 20px;
            background-color: white;
            border-top: 1px solid #e6e6e6;
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 24px;
            outline: none;
            font-size: 14px;
        }
        
        .send-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #6e8efb, #5a7dfa);
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .user-selection {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        
        .user-option {
            flex: 1;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .user-option:hover {
            border-color: #6e8efb;
            transform: translateY(-2px);
        }
        
        .user-option.selected {
            border-color: #6e8efb;
            background: #f0f4ff;
        }
        
        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 10px;
            border: 3px solid #6e8efb;
        }
        
        .status-info {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #28a745;
        }
        
        .notification-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #6e8efb;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Mobile-only styles */
        @media (max-width: 768px) {
            .navbar .nav-status {
                display: none; /* Remove online status on mobile */
            }
            
            .main-content {
                padding: 0;
                margin-top: 60px;
            }
            
            .container {
                max-width: 100%;
                height: calc(100vh - 60px);
                border-radius: 0;
                box-shadow: none;
            }
            
            .chat-header {
                position: fixed;
                top: 60px;
                width: 100%;
                z-index: 999;
                padding: 15px 20px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
            
            .chat-messages {
                margin-top: 70px;
                margin-bottom: 70px;
                padding: 15px;
            }
            
            .message {
                max-width: 90%;
            }
            
            .chat-input-container {
                position: fixed;
                bottom: 0;
                width: 100%;
                z-index: 999;
                padding: 15px 20px;
            }
            
            .user-selection {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Fixed Navigation Bar -->
    <nav class="navbar">
        <div class="nav-brand">
            <i class="fas fa-comments"></i>
            <span>Real-time WhatsApp Status</span>
        </div>
        <div class="nav-status">
            <div class="status-dot" id="globalStatusDot"></div>
            <span id="globalStatusText">Offline</span>
            <div class="nav-time" id="currentTime"></div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container">
            <!-- Login Screen -->
            <div id="loginScreen" style="padding: 30px; text-align: center;">
                <h2>Real-time Message Status</h2>
                <p style="margin-bottom: 20px; color: #666;">Select your user to test WhatsApp-style message status</p>
                
                <div class="notification-toggle">
                    <span>Enable Notifications:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="notificationToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="user-selection">
                    <div class="user-option" onclick="selectUser('person1')">
                        <img src="https://i.pravatar.cc/150?img=5" class="user-avatar">
                        <h3>Person 1 (Alex)</h3>
                        <p>Will see blue ticks when Person 2 reads</p>
                    </div>
                    <div class="user-option" onclick="selectUser('person2')">
                        <img src="https://i.pravatar.cc/150?img=12" class="user-avatar">
                        <h3>Person 2 (Sam)</h3>
                        <p>Will trigger blue ticks for Person 1</p>
                    </div>
                </div>
                
                <div class="status-info">
                    <h4><i class="fas fa-info-circle"></i> How it works:</h4>
                    <p><strong>Single tick:</strong> Message sent</p>
                    <p><strong>Double tick:</strong> Message delivered</p>
                    <p><strong>Blue double tick:</strong> Message read by recipient</p>
                    <p><em>Status updates in real-time without refresh!</em></p>
                </div>
            </div>
            
            <!-- Chat Interface -->
            <div id="chatScreen" style="display: none; height: 100%; flex-direction: column;">
                <div class="chat-header">
                    <h3 id="chatTitle">WhatsApp Style Chat</h3>
                    <p id="chatSubtitle">Real-time message status</p>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <div class="message received">
                        <img src="https://i.pravatar.cc/150?img=12" class="message-avatar">
                        <div class="message-content">
                            <p>Welcome! Send a message to see real-time status updates.</p>
                            <div class="message-time">
                                10:00 AM
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="messageInput" placeholder="Type a message...">
                    <button class="send-btn" id="sendButton">
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script>
        // === REPLACE THIS WITH YOUR FIREBASE CONFIG ===
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY_HERE",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        // === END OF FIREBASE CONFIG ===
        
        // App State
        let currentUser = null;
        let currentUserId = '';
        let otherUser = null;
        let unsubscribeMessages = null;
        let firebaseInitialized = false;
        let db = null;
        let messageElements = new Map(); // Store message elements for real-time updates
        let notificationsEnabled = false;
        
        // DOM Elements
        const loginScreen = document.getElementById('loginScreen');
        const chatScreen = document.getElementById('chatScreen');
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const chatTitle = document.getElementById('chatTitle');
        const chatSubtitle = document.getElementById('chatSubtitle');
        const globalStatusDot = document.getElementById('globalStatusDot');
        const globalStatusText = document.getElementById('globalStatusText');
        const currentTime = document.getElementById('currentTime');
        const notificationToggle = document.getElementById('notificationToggle');

        // User data
        const users = {
            'person1': {
                name: 'Alex Johnson',
                avatar: 'https://i.pravatar.cc/150?img=5',
                id: 'person1'
            },
            'person2': {
                name: 'Sam Wilson',
                avatar: 'https://i.pravatar.cc/150?img=12', 
                id: 'person2'
            }
        };

        // Update time function
        function updateTime() {
            const now = new Date();
            currentTime.textContent = now.toLocaleTimeString([], { 
                hour: '2-digit', minute: '2-digit' 
            });
        }

        // Update global status
        function updateGlobalStatus(active) {
            if (active) {
                globalStatusDot.classList.add('active');
                globalStatusText.textContent = 'Online';
            } else {
                globalStatusDot.classList.remove('active');
                globalStatusText.textContent = 'Offline';
            }
        }

        // Request notification permission
        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                console.log("This browser does not support notifications");
                return false;
            }
            
            if (Notification.permission === "granted") {
                console.log("Notification permission already granted");
                notificationsEnabled = true;
                return true;
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        console.log("Notification permission granted");
                        notificationsEnabled = true;
                        showNotification("Notifications Enabled", "You'll now receive notifications for new messages");
                        return true;
                    } else {
                        console.log("Notification permission denied");
                        notificationsEnabled = false;
                        notificationToggle.checked = false;
                        return false;
                    }
                });
            } else {
                console.log("Notification permission denied");
                notificationsEnabled = false;
                notificationToggle.checked = false;
                return false;
            }
        }

        // Show notification
        function showNotification(title, body) {
            if (!notificationsEnabled) return;
            
            // Check if the browser supports notifications
            if (!("Notification" in window)) {
                console.log("This browser does not support notifications");
                return;
            }

            // Check if notification permissions have been granted
            if (Notification.permission === "granted") {
                // Create notification
                const notification = new Notification(title, {
                    body: body,
                    icon: currentUser ? currentUser.avatar : 'https://i.pravatar.cc/150?img=5',
                    badge: 'https://cdn-icons-png.flaticon.com/512/733/733585.png'
                });

                // Close notification after 5 seconds
                setTimeout(() => {
                    notification.close();
                }, 5000);

                // Handle notification click
                notification.onclick = function() {
                    window.focus();
                    notification.close();
                };
            }
        }

        // Select user
        function selectUser(userId) {
            currentUser = users[userId];
            currentUserId = userId;
            otherUser = userId === 'person1' ? users['person2'] : users['person1'];
            
            // Update UI
            document.querySelectorAll('.user-option').forEach(opt => opt.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            
            // Show chat after short delay
            setTimeout(() => {
                startChat();
            }, 500);
        }

        // Start chat
        function startChat() {
            // Update chat header
            chatTitle.textContent = `Chat - ${currentUser.name}`;
            chatSubtitle.textContent = `Talking with ${otherUser.name}`;
            
            // Show chat interface
            loginScreen.style.display = 'none';
            chatScreen.style.display = 'flex';
            
            // Update global status
            updateGlobalStatus(true);
            
            // Initialize Firebase
            initializeFirebase();
        }

        // Initialize Firebase
        function initializeFirebase() {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                firebaseInitialized = true;
                console.log("Firebase initialized successfully");
                
                // Load messages and setup listeners
                loadMessages();
                setupRealTimeListeners();
                
            } catch (error) {
                console.error("Firebase initialization error: ", error);
                firebaseInitialized = false;
                alert("Firebase initialization failed. Please check your configuration.");
            }
        }

        // Load messages from Firestore
        function loadMessages() {
            if (!firebaseInitialized || !db) return;

            db.collection('whatsapp_messages')
                .orderBy('timestamp', 'asc')
                .get()
                .then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        const message = { id: doc.id, ...doc.data() };
                        displayMessage(message, false);
                    });
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                })
                .catch((error) => {
                    console.error("Error loading messages: ", error);
                });
        }

        // Setup real-time listeners for message updates
        function setupRealTimeListeners() {
            if (!firebaseInitialized || !db) return;

            // Listen for new messages
            unsubscribeMessages = db.collection('whatsapp_messages')
                .orderBy('timestamp', 'asc')
                .onSnapshot((querySnapshot) => {
                    querySnapshot.docChanges().forEach((change) => {
                        const message = { id: change.doc.id, ...change.doc.data() };
                        
                        if (change.type === "added") {
                            // New message - display it
                            if (!messageElements.has(message.id)) {
                                displayMessage(message, true);
                                
                                // If message is from other user, mark as read immediately
                                if (message.senderId !== currentUserId) {
                                    markMessageAsRead(message.id);
                                    
                                    // Show notification for new message from other user
                                    if (notificationsEnabled && document.hidden) {
                                        showNotification(
                                            `${message.sender}`, 
                                            message.text.length > 50 
                                                ? `${message.text.substring(0, 50)}...` 
                                                : message.text
                                        );
                                    }
                                }
                            }
                        } 
                        else if (change.type === "modified") {
                            // Message updated - update status in real-time
                            updateMessageStatus(message.id, message);
                            
                            // Show notification when message is read (blue tick)
                            if (message.read && message.senderId === currentUserId && notificationsEnabled) {
                                showNotification("Message Read", `${otherUser.name} read your message`);
                            }
                        }
                    });
                });
        }

        // Mark message as read
        function markMessageAsRead(messageId) {
            if (!firebaseInitialized || !db) return;

            db.collection('whatsapp_messages').doc(messageId).update({
                read: true,
                readBy: currentUserId,
                readAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                console.log("Message marked as read");
            })
            .catch((error) => {
                console.error("Error marking message as read: ", error);
            });
        }

        // Send message
        function sendMessage() {
            const messageText = messageInput.value.trim();
            
            if (!messageText) return;

            // Create message object
            const message = {
                text: messageText,
                sender: currentUser.name,
                senderId: currentUserId,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'sent',
                delivered: false,
                read: false
            };

            // Clear input
            messageInput.value = '';

            // Save to Firebase
            if (firebaseInitialized && db) {
                db.collection('whatsapp_messages').add(message)
                    .then((docRef) => {
                        console.log("Message sent with ID: ", docRef.id);
                        
                        // Update status to delivered after a short delay
                        setTimeout(() => {
                            db.collection('whatsapp_messages').doc(docRef.id).update({
                                delivered: true,
                                deliveredAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }, 1000);
                    })
                    .catch((error) => {
                        console.error("Error sending message: ", error);
                    });
            }
        }

        // Display message with real-time status
        function displayMessage(message, animate = true) {
            // Check if message already exists
            if (messageElements.has(message.id)) {
                updateMessageStatus(message.id, message);
                return;
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.senderId === currentUserId ? 'sent' : 'received'}`;
            messageDiv.dataset.messageId = message.id;

            if (animate) {
                messageDiv.style.animation = 'slideIn 0.3s ease';
            }

            const avatarSrc = message.senderId === currentUserId ? currentUser.avatar : otherUser.avatar;

            // Format timestamp
            let timeString = 'Just now';
            if (message.timestamp) {
                if (message.timestamp.toDate) {
                    const date = message.timestamp.toDate();
                    timeString = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                }
            }

            // Get status indicator
            const statusIndicator = getStatusIndicator(message);

            messageDiv.innerHTML = `
                <img src="${avatarSrc}" class="message-avatar">
                <div class="message-content">
                    <p>${message.text}</p>
                    <div class="message-time">
                        ${timeString}
                        ${statusIndicator}
                    </div>
                </div>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Store message element for real-time updates
            messageElements.set(message.id, messageDiv);
        }

        // Get WhatsApp-style status indicator
        function getStatusIndicator(message) {
            if (message.senderId !== currentUserId) {
                return ''; // No status for received messages
            }

            if (message.read) {
                return '<span class="message-status status-double-tick-blue"><i class="fas fa-check-double"></i></span>';
            } else if (message.delivered) {
                return '<span class="message-status status-double-tick"><i class="fas fa-check-double"></i></span>';
            } else {
                return '<span class="message-status status-single-tick"><i class="fas fa-check"></i></span>';
            }
        }

        // Update message status in real-time
        function updateMessageStatus(messageId, message) {
            const messageDiv = messageElements.get(messageId);
            if (!messageDiv) return;

            const statusElement = messageDiv.querySelector('.message-status');
            const newStatusIndicator = getStatusIndicator(message);

            if (statusElement) {
                statusElement.outerHTML = newStatusIndicator;
            } else if (newStatusIndicator) {
                const timeElement = messageDiv.querySelector('.message-time');
                timeElement.innerHTML += newStatusIndicator;
            }

            // Re-store the updated element
            messageElements.set(messageId, messageDiv);
        }

        // Initialize
        updateTime();
        setInterval(updateTime, 60000);
        updateGlobalStatus(true);

        // Event Listeners
        sendButton.addEventListener('click', sendMessage);
        
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Notification toggle
        notificationToggle.addEventListener('change', function() {
            if (this.checked) {
                requestNotificationPermission();
            } else {
                notificationsEnabled = false;
            }
        });

        // Auto-mark messages as read when chat is active
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Mark all messages from other user as read
                messageElements.forEach((element, messageId) => {
                    const messageDiv = element;
                    if (messageDiv.classList.contains('received')) {
                        markMessageAsRead(messageId);
                    }
                });
            }
        });

        // Mark messages as read when scrolling to bottom
        chatMessages.addEventListener('scroll', function() {
            if (chatMessages.scrollTop + chatMessages.clientHeight >= chatMessages.scrollHeight - 10) {
                messageElements.forEach((element, messageId) => {
                    if (element.classList.contains('received')) {
                        markMessageAsRead(messageId);
                    }
                });
            }
        });

        console.log("Chat app initialized - Real-time status updates enabled");
    </script>
</body>
</html>
